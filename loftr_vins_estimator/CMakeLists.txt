cmake_minimum_required(VERSION 3.10)
project(loftr_vins)

set(CMAKE_BUILD_TYPE "Release")

# ğŸ”§ MODIFIED: å‡çº§åˆ°C++17 (TensorRTå’Œfilesysteméœ€è¦)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_FLAGS "-std=c++17")

# æ·»åŠ ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -Wall -g -march=native -mtune=native")

# æ·»åŠ CUDAæ”¯æŒ
find_package(CUDA REQUIRED)
enable_language(CUDA)

find_package(catkin REQUIRED COMPONENTS
    roscpp
    rosbag
    std_msgs
    geometry_msgs
    nav_msgs
    tf
    cv_bridge
    camera_models
    image_transport)

find_package(OpenCV REQUIRED)
find_package(Ceres REQUIRED)

# ONNX Runtimeé…ç½®
set(ONNXRUNTIME_ROOTDIR "/home/lin/Documents/onnxruntime-linux-aarch64-gpu-1.16.0")

# ğŸ”§ ä¿®å¤çš„TensorRT 8.5.2é…ç½®
set(TENSORRT_INCLUDE_DIR "/usr/include/aarch64-linux-gnu")
set(TENSORRT_LIB_DIR "/usr/lib/aarch64-linux-gnu")

# æŸ¥æ‰¾TensorRTåº“æ–‡ä»¶ (ä½¿ç”¨æ­£ç¡®çš„åº“å)
find_library(TENSORRT_LIBRARIES nvinfer
    PATHS ${TENSORRT_LIB_DIR}
    NO_DEFAULT_PATH)

find_library(TENSORRT_PLUGIN_LIBRARIES nvinfer_plugin
    PATHS ${TENSORRT_LIB_DIR}
    NO_DEFAULT_PATH)

find_library(TENSORRT_ONNX_LIBRARIES nvonnxparser
    PATHS ${TENSORRT_LIB_DIR}
    NO_DEFAULT_PATH)

# éªŒè¯TensorRTå®Œæ•´æ€§
if(TENSORRT_LIBRARIES AND EXISTS "${TENSORRT_INCLUDE_DIR}/NvInfer.h")
    # ğŸ”§ ä½¿ç”¨æ­£ç¡®çš„å®å®šä¹‰
    add_definitions(-DTENSORRT_AVAILABLE)
    include_directories(${TENSORRT_INCLUDE_DIR})
    
    message(STATUS "âœ… TensorRT 8.5.2 FOUND AND CONFIGURED!")
    message(STATUS "   - Include: ${TENSORRT_INCLUDE_DIR}")
    message(STATUS "   - Core Library: ${TENSORRT_LIBRARIES}")
    if(TENSORRT_PLUGIN_LIBRARIES)
        message(STATUS "   - Plugin Library: ${TENSORRT_PLUGIN_LIBRARIES}")
    endif()
    if(TENSORRT_ONNX_LIBRARIES)
        message(STATUS "   - ONNX Library: ${TENSORRT_ONNX_LIBRARIES}")
    endif()
    
    set(TENSORRT_FOUND TRUE)
else()
    message(WARNING "âš ï¸ TensorRT not found or incomplete")
    message(STATUS "   - TensorRT Libraries: ${TENSORRT_LIBRARIES}")
    message(STATUS "   - Include path: ${TENSORRT_INCLUDE_DIR}")
    set(TENSORRT_FOUND FALSE)
endif()

# æ·»åŠ åº“ç›®å½•
link_directories("${ONNXRUNTIME_ROOTDIR}/lib")
if(TENSORRT_FOUND)
    link_directories(${TENSORRT_LIB_DIR})
endif()

# åŒ…å«ç›®å½•
include_directories(${PROJECT_SOURCE_DIR}/src/featureTracker/ort_include/)
include_directories(${PROJECT_SOURCE_DIR}/src/estimator/)
include_directories(${catkin_INCLUDE_DIRS} ${CERES_INCLUDE_DIRS})

# æ·»åŠ CUDAå¤´æ–‡ä»¶
include_directories(${CUDA_INCLUDE_DIRS})

set(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/cmake)
find_package(Eigen3)
include_directories(
  ${catkin_INCLUDE_DIRS}
  ${EIGEN3_INCLUDE_DIR}
)

catkin_package()

# ğŸ”§ ä¿®å¤ï¼šåªä¿ç•™å¿…è¦çš„ç¼–è¯‘å™¨å®šä¹‰
add_definitions(-DWITH_LOFTR)

# LoFTR VINS ä¸»åº“
add_library(loftr_vins_lib
    # æ ¸å¿ƒä¼°è®¡å™¨æ–‡ä»¶
    src/estimator/parameters.cpp
    src/estimator/estimator.cpp
    src/estimator/feature_manager.cpp
    
    # ä¼˜åŒ–å› å­
    src/factor/pose_local_parameterization.cpp
    src/factor/projectionTwoFrameOneCamFactor.cpp
    src/factor/projectionTwoFrameTwoCamFactor.cpp
    src/factor/projectionOneFrameTwoCamFactor.cpp
    src/factor/marginalization_factor.cpp
    
    # å·¥å…·ç±»
    src/utility/utility.cpp
    src/utility/visualization.cpp
    src/utility/CameraPoseVisualization.cpp
    
    # åˆå§‹åŒ–
    src/initial/solve_5pts.cpp
    src/initial/initial_aligment.cpp
    src/initial/initial_sfm.cpp
    src/initial/initial_ex_rotation.cpp
    
    # ç‰¹å¾è·Ÿè¸ª - åŸºç¡€æ–‡ä»¶
    src/featureTracker/feature_tracker.cpp
    src/featureTracker/feature_tracker_dpl.cpp
    src/featureTracker/transform_dpl.cpp
    
    # LoFTR ç›¸å…³æ–‡ä»¶
    src/featureTracker/loftr_interface.cpp
    src/featureTracker/loftr_tensorrt.cpp
    src/featureTracker/loftr_onnx.cpp
    src/featureTracker/loftr_utils.cpp
)

# ğŸ”§ ä¿®å¤ï¼šåŸºç¡€åº“é“¾æ¥
target_link_libraries(loftr_vins_lib 
    ${catkin_LIBRARIES}
    ${OpenCV_LIBS}
    ${CERES_LIBRARIES}
    onnxruntime
    ${CUDA_LIBRARIES}
    cudart
    cublas
    curand
    cudnn)

# ğŸ”§ ä¿®å¤ï¼šTensorRTåº“é“¾æ¥ï¼ˆç»Ÿä¸€æ”¾åœ¨è¿™é‡Œï¼‰
if(TENSORRT_FOUND)
    target_link_libraries(loftr_vins_lib ${TENSORRT_LIBRARIES})
    
    if(TENSORRT_PLUGIN_LIBRARIES)
        target_link_libraries(loftr_vins_lib ${TENSORRT_PLUGIN_LIBRARIES})
    endif()
    
    if(TENSORRT_ONNX_LIBRARIES)
        target_link_libraries(loftr_vins_lib ${TENSORRT_ONNX_LIBRARIES})
    endif()
endif()

# è®¾ç½®CUDAæ¶æ„ (Jetson AGX Orinæ˜¯Ampereæ¶æ„)
set_property(TARGET loftr_vins_lib PROPERTY CUDA_SEPARABLE_COMPILATION ON)
set_property(TARGET loftr_vins_lib PROPERTY CUDA_ARCHITECTURES "87")  # Orinæ˜¯sm_87

# ä¸»å¯æ‰§è¡Œæ–‡ä»¶
get_filename_component(PROJECT_SOURCE_DIR_ABS "${CMAKE_SOURCE_DIR}" ABSOLUTE)
add_executable(loftr_vins_node src/loftr_vins_main.cpp)
target_compile_definitions(loftr_vins_node PRIVATE PROJECT_SOURCE_DIR="${PROJECT_SOURCE_DIR_ABS}")
target_link_libraries(loftr_vins_node loftr_vins_lib)

# LoFTR æµ‹è¯•ç¨‹åº (å¯é€‰)
add_executable(loftr_test src/loftr_test.cpp)
target_link_libraries(loftr_test loftr_vins_lib)

# LoFTR æ€§èƒ½æµ‹è¯• (å¯é€‰)
add_executable(loftr_benchmark src/loftr_benchmark.cpp)
target_link_libraries(loftr_benchmark loftr_vins_lib)

# è°ƒè¯•ä¿¡æ¯
message(STATUS "============ LoFTR VINS Build Configuration ============")
message(STATUS "PROJECT_NAME: ${PROJECT_NAME}")
message(STATUS "CMAKE_BUILD_TYPE: ${CMAKE_BUILD_TYPE}")
message(STATUS "CMAKE_CXX_STANDARD: ${CMAKE_CXX_STANDARD}")
message(STATUS "ONNXRUNTIME_ROOTDIR: ${ONNXRUNTIME_ROOTDIR}")
message(STATUS "CUDA_VERSION: ${CUDA_VERSION}")
if(TENSORRT_FOUND)
    message(STATUS "TensorRT: ENABLED")
    message(STATUS "TensorRT_LIBRARIES: ${TENSORRT_LIBRARIES}")
else()
    message(STATUS "TensorRT: DISABLED")
endif()
message(STATUS "OpenCV_VERSION: ${OpenCV_VERSION}")
message(STATUS "LoFTR Support: ENABLED")
message(STATUS "=======================================================")
